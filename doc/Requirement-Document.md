# 证券交易系统模拟器 STS (Security Trading Simulator)

$$经56 王思萍 #2015012527$$
## 1 选题背景意义

###1.1 选题初衷
“炒股”是一个人尽皆知的词语。根据2017年中登公司公布的数据，我国的二级市场是以中小投资者为主的市场，其中A股散户的比重超过80%。如今市面上侧重价值分析、技术分析的教程层出不穷，但真正清楚二级市场交易的基本原理与规则的股民少之又少。

金融专业本科教学往往不涉及交易形成的机制，学生也很难通过一个step-by-step的形式“看到”市场决定价格的过程。尤其是对于尚未有过实习经历或投资经历的低年级同学来说，入门抽象的金融领域通常是有些困难的。

**STS模拟器为使用者创造了一个最基础、最原始的交易环境，能够让未受过系统金融学教育的人们了解最基本的二级市场交易原则，“看见”市场决定股票价格的过程。**

---

本人对量化金融与交易系统开发很感兴趣，也是今后想要发展的方向。希望通过实现这个模拟器来接触与应用 `类与对象` 、 `数据库` 、 `命令解析器` 等模块的搭建，为之后的学习与求职打下基础。
###1.2 理论意义

通过对STS模拟器的适当改造（例如增加**自动发出交易请求、批量生成正态分布的买卖叫价与股数**等功能）并与真实市场数据相结合，可以实现类似 *Monte·Carlo* 的模拟过程，从而可以指导证券市场价格机制、股票价格预测、不同因子对市场定价的影响权重等金融相关领域的研究。
###1.3 实践意义

适用群体|实用价值
:--:|:--:
金融专业学生|使用STS进行模拟交易，了解交易机制；包括上市价格、开盘价与收盘价、交易价格的变动、账户变动、“t+1”规定等；通过对模拟器的适当改造，指导证券交易研究。
希望学习证券交易知识的人群|使用STS进行模拟交易，了解交易机制；包括上市价格、开盘价与收盘价、交易价格的变动、账户变动、“t+1”规定等。
商业竞赛/模拟投资比赛组织|使用STS模拟器进行模拟证券交易市场的建立与运行；给参赛人员分配账号，在系统中进行模拟交易，并进行收益率的统计与排名。

## 2 同类软件调研分析

考虑到证券交易系统模拟器同时具有 `交易系统` 与 `模拟器` 的特征，本章将分析两类软件，分别是现实中常用的股票交易系统与教学中用到的模拟器。

###2.1 具有模拟证券交易功能的软件代表：同花顺
**（一）软件功能介绍**

同花顺股票软件是一个提供行情显示、行情分析和行情交易的股票软件，它分为免费PC产品，付费PC产品，电脑平板产品，手机产品等适用性强的多个版本。以同花顺的移动客户端为例，该软件主要涵盖以下三大功能：

- **证券信息查询。**同花顺公司与上交所、深交所、香港联交所、金交所已经建立了紧密的合作关系，是上海证券交易所指定的22家Level-2的数据发布商之一。软件向股民提供了大量且免费的证券信息和数据。

<img src= /Users/wangsiping/Documents/GitHub/Stock_Trading_Simulator/2.jpeg width="600"></img>

- **客户端炒股。**无空间地域限制，让投资者可以随时随地进行交易。同花顺的手机炒股是国内最大、支持手机型号最多、支持运营商最完善的服务提供商，**市场占有率高达60%**。同时，同花顺的网上交易系统已广泛应用于全国107家证券公司中的97家券商的2600多家营业部中，**覆盖率在90.5%以上**。
- **模拟交易（委托交易）。**同花顺可以为用户创建模拟交易账户，起始资金20万元，让用户通过模拟交易来检验自己的投资逻辑；同时会统计周/月收益率排名，用户可以看到自己收益率的排名，但不会看到其他用户的投资组合。

<img src= /Users/wangsiping/Documents/GitHub/Stock_Trading_Simulator/1.jpeg width="400"></img>

**（二）特点分析**

- **优点：**模拟交易非常容易操作，用户的账户界面简洁清晰，证券信息齐全。
- **不足：**由于是与现实的股价直接对接，因此使用模拟交易功能的用户无法对股价产生影响，交易结果全凭外部市场价格，不利于加深对交易机制的体验和理解。
- **改善方案：**STS除计划实现上述功能中的第一（证券信息查询）与第三（模拟交易）功能外，还计划**添加交易算法，模拟现实交易中由用户（市场）决定股价的机制，而不仅仅是将现有股价直接带入计算资产金额**。

###2.2 模拟器软件代表：Camera
**（一）软件介绍**

*[Camera](http://gdlp01.c-wss.com/gds/6/0300022616/01/pssx720hs-cu-en.pdf)*是一款基于Java语言的对高速缓存与主存的三种映射方式过程的模拟器。这个软件主要适用于教育教学环节，能够让学生看到高速缓存对不同主存地址的映射过程和结果；同时，也可以通过对这个软件的简单改造，计算不同映射方式下的命中率和相对时间。而这些功能仅通过简单输入地址或令系统自动生成地址即可实现。

<img src= /Users/wangsiping/Desktop/大四/计算机系统原理/7.png width="600"></img>


**（二）特点分析**

- **优点：**操作非常简单，图形化界面非常清晰；在界面最下方有对映射过程的每一步骤的详细描述，能够让学生更好地理解这些过程。
- **不足：**无法导出文件，无法修改已经输入的数据（地址），软件关闭之后所有数据即消失；同时，模拟器中Cache的容量是固定的，无法更改。
- **改善方案：**STS计划实现模拟器的功能主要为能够让用户随时查看自己的中标情况，从而观察到自己的投/中标与成交价/股价的关系。同时还将**添加文件功能，能够保留投资者和证券的账户，在投资者登出的情况下，其投标仍然能够保留**；且证券数目由管理员（多人使用时）或用户（单人模拟时）手动设置，**不设最大限制**。

## 3 详细功能设计
### 3.1 前端功能

前端功能为人机交互功能，分为 `投资者` 与 `证券业务人员` 两部分。

**（〇）程序开始运行后，首先询问使用者是投资者还是证券业务人员**

```
Welcome to STS! Are you an Investor (I) or a security manager (S)? 
I/S?
```
若回答"S"，则进入业务模式。并自动弹出该模式下的 `COMMAND LIST` （见 `3.1.2（一）1）` ）。

若回答"I"，则进入投资者模式，并自动弹出该模式下的 `COMMAND LIST` （见 `3.1.1（一）1）` ）。

若回答其他，则再次打印询问语句，直至输入内容合法为止。例如：

```
Welcome to STS! Are you an investor (I) or a security manager (S)? 
I/S? hmmm // 回答"I"与"S"之外的内容
Welcome to STS! Are you an investor (I) or a security manager (S)? 
I/S?
```
####3.1.1 投资者模式下的交互

**（一）登录前可输入的指令**

1）查看`COMMAND LLIST`：`help`指令

```
STS-I:~$ help
---------------------- COMMAND LIST ----------------------
help                                     show command list
reg [username]                              register an id
log [username]                                      log in
reset                            quit investor environment
----------------------------------------------------------
```
2）注册：`reg`指令

```
STS-I:~$ reg testuser // 创建用户名为 “testuser” 的用户
```
如果`testuser`已经被注册过，则报错：

```
'testuser' has already been registered, please use another name.
STS-I:~$ 
```
如果新用户名合法，则继续设置密码：

```
password: 123456 // 输入密码
confirm password: 123456 // 确认密码
Welcome, testuser!
STS-I:~testuser$ // 进入登录环境，可输入后续指令
```
若前后密码不匹配，则报错并要求再次输入密码：

```
Wrong password! Please reset your password.
password: // 再次输入密码
```

3）登录：`log`指令

```
STS-I:~$ log testuser
```
若用户名不存在，则报错，并返回初始状态：

```
'testuser' does not exists. Please check your username or use 'reg' to register.
STS-I:~$ // 返回初始状态
```
若密码错误，则报错，并返回初始状态：

```
Log-in failed! Please check your username or password.
STS-I:~$ // 返回初始状态
```
若登录成功，则进入登录环境：

```
Welcome, testuser!
STS-I:~testuser$ // 进入登录环境，可输入后续指令
```
4）返回初始状态（用于切换身份）：`reset`指令

```
STS-I:~$ reset
Successfully quitted investor environment.
Welcome to STS! Are you an investor (I) or a security manager (S)? 
I/S? // 返回初始状态
```

**（二）登录后可输入的指令：**

1）查看`COMMANF LIST`：`help`指令

```
STS-I:~testuser$ help
---------------------- COMMAND LIST ----------------------
help                                     show command list
t+ [SecuCode] [Number of Shares] [price]   long a security
t- [SecuCode] [Number of Shares] [price]  short a security
account                            see your account status
select ... from ...                      look up secu-info
quit                                               log out
----------------------------------------------------------
```
2） 以某价格买入某股数的某证券的请求

- 't+' + `SecuCode` + `Number of Shares` + `price` 

```
// 例：以 22.00 元/股 的价格购买入 100 股 000001 代码的股票
STS-I:~testuser$ t+ 000001 100 22.00
Request received! 
```
3） 以某价格卖出某股数的某证券的请求

- 't-' + `SecuCode` + `Number of Shares` + `price` 

```
// 例：以 22.00 元/股 的价格购卖出 100 股 000001 代码的股票
STS-I:~testuser$ t- 000001 100 22.00
Request received!
```

4）查询自己账户情况：`account`指令

```
STS-I:~testuser$ account
```
返回一个包含账户信息的列表，如下所示：

testuser|金额|持仓|成本价|现价|盈亏（%）
:--|:--|:--|:--|:--
000001|32100.00|300|69.40|107.00|54.18
000002|94799.00|100|688.80|947.99|37.63
可用|55596.97| ||
总资产|182495.57| ||

其中：

- `金额` = `持仓` X `现价`
-  `盈亏` = `现价` / `成本价` X 100% - 1
- `总资产` = 所有项`金额`的总和

5）查询指定证券信息：类似`SQL`语法

```
STS-I:~testuser$ select price from 000001 // 查找 000001 的价格信息
STS-I:~testuser$ select industry from 000001 // 查找 000001 的行业信息
STS-I:~testuser$ select index from 000001 // 查找 000001 的重要财务信息
STS-I:~testuser$ select * from 000001 // 查找 000001 的以上所有信息
```
返回包含该证券相应信息的列表（以 `select * from 000001` 为例）：

SecuCode|000001
:--|:--
Price|107.00
Industry|Food
Floats|10000
ROA(%)|10.00
ROE(%)|11.00

6）退出：`quit`指令

```
STS-I:~testuser$ quit
Successfully quitted 'testuser'.
STS-I:~$ 
```
**（三）报错**

除上文提到的报错条件外，下列情况若有发生也将报错：

1）指令合法性检验：若用户输入不合法的指令，则报错；

2）账户余额检验：若用户输入的购买请求资金总额（= 股数 X 价格）大于账户中可用资金，则报错；

3）账户持仓检验：若用户输入的卖出请求中的股数大于自身账户中对应股票的持仓数（无对应股票时，持仓数 = 0），则报错；

4）流通股本数检验：若用户输入的购买请求中的股数大于该证券现有的流通股本数，则报错。
####3.1.2 业务模式下的交互
**（一）登录前可输入的指令**

1）查看`COMMAND LLIST`：`help`指令

```
STS-S:~$ help
---------------------- COMMAND LIST ----------------------
help                                     show command list
log [SecuCode]                                      log in
reset                                quit secu environment
----------------------------------------------------------
```
2）登录：`log`指令

```
STS-S:~$ log 000001
```
若`SecuCode`不存在，则报错，并返回初始状态：

```
'000001' does not exists. Please check your SecuCode.
STS-S:~$ // 返回初始状态
```
若密码错误，则报错，并返回初始状态：

```
Log-in failed! Please check your SecuCode or password.
STS-S:~$ // 返回初始状态
```
若登录成功，则进入登录环境：

```
Welcome, 000001!
STS-S:~000001$ // 进入登录环境，可输入后续指令
```
3）返回初始状态（用于切换身份）：`reset`指令

```
STS-S:~$ reset
Successfully quitted investor environment.
Welcome to STS! Are you an investor (I) or a security manager (S)? 
I/S? // 返回初始状态
```
**（二）登录后可输入的指令：**

1）查看`COMMANF LIST`：`help`指令

```
STS-S:~000001$ help
---------------------- COMMAND LIST ----------------------
help                                     show command list
me                                      see your secu-info
floats [new num of floats]                    reset floats
industry [new industry]                     reset industry
roa [new roa]                                    reset roa
roe [new roe]                                    reset roe
quit                                               log out
----------------------------------------------------------
```
2） 信息查询：业务者可通过`me`指令查询自己的证券信息

```
STS-S:~000001$ me
```
返回包含该证券全部信息的列表：

SecuCode|000001
:--|:--
Price|107.00
Industry|Food
Floats|10000
ROA(%)|10.00
ROE(%)|11.00

3）公司发生增发、回购、分割等导致流通股本数(`Floats`)变化的行为时：**由于现实情况下这一数据通常都是从在线数据库中直接获得，**因此模拟器中设计了一个直接更新流通股本数目的指令，而不再设其他对流通股本进行操作的指令。

- `floats`指令直接改变流通股本数：

```
STS-S:~000001$ floats 15000 // 流通股本数变更为 15000
```
需要注意的是，公司流通股本数目变化时会对股价和持有者所持股数产生作用，因此需要对股价和持有者账户情况进行更新（见`3.2.3（三）`）。

4）公司更改行业或其他重要财务信息：同样**由于现实情况下这些数据通常都是从在线数据库中直接获得，**因此模拟器中可直接通过指令更新这些信息。

```
STS-S:~000001$ industry Internet // 将所属行业改为“互联网”
STS-S:~000001$ roa 10.5 // 将 ROA 改为 10.50%
STS-S:~000001$ roe 13 // 将 ROE 改为13.00%
```
这些更改将不会对股票价格产生影响，因此不需要对股价和账户进行更新。

5）退出：`quit`指令

```
STS-S:~000001$ quit
STS-S:~$ // 退出登录环境
```
**（三）报错**

指令合法性检验：若用户输入不合法的指令，则报错。

####3.1.3 退出程序指令`exit`

退出系统指令**当且仅当在退出登录环境后**才可以使用。输入指令及密码后，系统默认“当天”交易结束，对未成交部分对应的用户的`可用`项目进行还原（见`3.2.3（三）`），并退出程序。

例如，投资者模式下：

```
STS-I:~$ exit 654321 // 密码
Successfully updated data. Bye~ // 退出程序 
```

###3.2 后端功能
####3.2.1 模拟交易机制
对于每支股票：

- 在单次程序运行期间，存储来自不同投资者的买入请求与卖出请求；
- 在新的请求进入后：
  - 对买入请求的买价从高到底排序，最低价记为 pb，对应的股数记为 nb；
  - 对卖出请求的卖价从低到高排序，最高价记为 ps，对应的股数记为 ns；
  - 若有 pb >= ps，则成交发生，成交价为 s；成交量为 min(nb, ns)；
     - 若成交量为 nb，则将对应的买入请求移除，卖出请求保留，对应股数更新为 （ns - nb）；
     - 若成交量为 ns，则将对应的卖出请求移除，买入请求保留，对应股数更新为 （nb - ns）；
     - 若 nb = ns，则同时移除两请求；
  - 反之，则无交易发生。
- 重复上述过程直至退出程序。

####3.2.2 访问与读写权限
**（一）访问权限**

用户类别|投资者账户|证券信息
:--|:--|:--
投资者|仅自己账户|所有
业务者|无权限|仅自己

**（二）读写权限**

用户类别|投资者账户|证券信息
:--|:--|:--
投资者|只读|只读
业务者|无权限|读写均可，但不可修改股价与股票代码

同时，业务者无法创建或注销股票。

####3.2.3 数据维护与更新
**（一）投资者与证券的初始化**

1）投资者的初始化

当一个新的用户名被创建时，其用户名、密码将被写入投资者`Config`文件中。同时系统自动为其创建账户并给予初始资金 20 万元，即：账户名称为该用户的用户名，`资产总值`与`可用资金`项均为 20 万元，**无证券入账**，并写入用户`Account`文件中。下表为初始状态的账户情况：

testuser|金额|持仓|成本价|现价|盈亏（%）
:--|:--|:--|:--|:--
可用|200000.00
总资产|200000.00

2）证券的初始化

证券由后台初始化，其股票代码与密码已写在从业者`Config`文件中，其他信息已写在从业者`Info`文件中。在模拟器中，初始的股价仅供投资者参考。

**（二）数据存储形式**

数据|永久存储|暂存（程序关闭后即删除）
:--|:--:|:--:
投资者`Config`|&radic; |
投资者`Account`|&radic;|
业务者`Config`|&radic;|
业务者`Info`|&radic;|
未成交的交易请求||&radic;（对现实中“t+1”的模拟）

**（三）数据更新**

1. 成交时，对股价及交易双方账户中对应股票的 `持仓` `成本价` `可用` 项目的更新；若之前账户中无对应股票，则添加该股票的对应内容
   - 股价 = 最新成交价
   - 持仓 = 原持仓 +/- 成交数目
   - 成本价（仅购买者更新） = 成交价 
   - 可用 = 原可用金额 +/- 成交数目 X 成交价
2. 股价发生变化时，对股票信息中的`Price`及其**所有**持有者账户的更新
   - Price = 现价 = 最新股价
   - 股票对应金额 = 现价 X 持仓
3. 投资者发出购买请求时，其账户中`可用`项目的变化
   - 可用 = 原可用金额 - 叫价 X 股数
4. 系统关闭时，对未成交部分对应的用户的`可用`项目进行还原
   - 可用 = 原可用金额 + 叫价 X 未成交部分的股数
   - 未成交部分的股数 = 叫价股数 - 成交的股数
5. 公司流通股本数(`Floats`)变化时，对股价与**所有**持有者账户的更新
   - 原股价 X 原股数 = 现股价 X 现股数
   - 持仓 = 原持仓 X 现股数 / 原股数
   - 进行“数据更新2”的部分



